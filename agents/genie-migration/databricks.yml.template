# Databricks Asset Bundle for Genie Space Migration
# See https://docs.databricks.com/dev-tools/bundles/index.html
#
# SETUP: Copy this file to databricks.yml and configure your workspace settings.
#        cp databricks.yml.template databricks.yml

bundle:
  name: genie-migration

variables:
  # TODO: SQL Warehouse ID for Genie Space in target workspace
  warehouse_id:
    description: "SQL Warehouse ID for Genie Space"
    default: ""

  # TODO: Workspace path where Genie Space will be created
  genie_parent_path:
    description: "Workspace path for Genie Space"
    default: "/Shared/genie_spaces"

  # TODO: Genie Space config file to deploy (relative to bundle files root)
  genie_config:
    description: "Path to Genie Space JSON config file"
    default: "/Workspace/Shared/.bundle/genie-migration/${bundle.target}/files/genie_spaces/sample_space.json"

  # TODO: Space ID for idempotent updates (set after first deploy)
  space_id:
    description: "Existing Genie Space ID to update"
    default: ""

  # TODO: Source space ID for export operations
  source_space_id:
    description: "Source Genie Space ID to export"
    default: ""

  # TODO: Output path for exports (directory - filename will be generated from space title)
  export_output:
    description: "Output directory for exported Genie Space config"
    default: "/Workspace/Shared/genie_exports"

  # TODO: Production workspace host (for prod target)
  prod_workspace_host:
    description: "Production workspace URL"
    default: ""

  # TODO: Service Principal application ID for job execution (required for SP auth)
  run_as_service_principal:
    description: "Service Principal application ID to run jobs as"
    default: ""

artifacts:
  genie_migration_wheel:
    type: whl
    path: .

resources:
  jobs:
    export_genie_space:
      name: "genie-export-${bundle.target}"
      description: "Export a Genie Space configuration to JSON"
      run_as:
        service_principal_name: ${var.run_as_service_principal}
      tasks:
        - task_key: export
          python_wheel_task:
            package_name: genie_migration
            entry_point: genie-export
            parameters:
              - "--space-id=${var.source_space_id}"
              - "--output=${var.export_output}"
              - "--verbose"
          environment_key: default
      environments:
        - environment_key: default
          spec:
            client: "1"
            dependencies:
              - databricks-sdk>=0.76.0
      timeout_seconds: 600
      max_concurrent_runs: 1

    deploy_genie_space:
      name: "genie-deploy-${bundle.target}"
      description: "Deploy a Genie Space from JSON configuration"
      run_as:
        service_principal_name: ${var.run_as_service_principal}
      tasks:
        - task_key: deploy
          python_wheel_task:
            package_name: genie_migration
            entry_point: genie-deploy
            parameters:
              - "--config=${var.genie_config}"
              - "--warehouse-id=${var.warehouse_id}"
              - "--parent-path=${var.genie_parent_path}"
              - "--verbose"
          environment_key: default
      environments:
        - environment_key: default
          spec:
            client: "1"
            dependencies:
              - databricks-sdk>=0.76.0
      timeout_seconds: 600
      max_concurrent_runs: 1

targets:
  # Development target - configure via DATABRICKS_HOST env var or update host below
  dev:
    default: true
    workspace:
      # Uncomment and set your dev workspace URL:
      # host: https://adb-<workspace-id>.<region>.azuredatabricks.net
      # Deploy to /Shared so Service Principal can access the files
      root_path: /Shared/.bundle/${bundle.name}/${bundle.target}

  # Production target - set via variables or CI/CD
  prod:
    workspace:
      host: ${var.prod_workspace_host}
      root_path: /Shared/.bundle/${bundle.name}/${bundle.target}
    variables:
      warehouse_id: ${var.warehouse_id}
