# Databricks Asset Bundle for Genie Space Migration
# See https://docs.databricks.com/dev-tools/bundles/index.html
#
# SETUP: Copy this file to databricks.yml and configure your workspace settings.
#        cp databricks.yml.template databricks.yml

bundle:
  name: genie-migration

variables:
  # SQL Warehouse ID for Genie Space in target workspace
  warehouse_id:
    description: "SQL Warehouse ID for Genie Space"

  # Workspace path where Genie Space will be created
  genie_parent_path:
    description: "Workspace path for Genie Space"
    default: "/Shared/genie_spaces"

  # Genie Space config file to deploy
  genie_config:
    description: "Path to Genie Space JSON config file"
    default: "genie_spaces/sample_space.json"

  # Space ID for idempotent updates (set after first deploy)
  space_id:
    description: "Existing Genie Space ID to update"
    default: ""

  # Source space ID for export operations
  source_space_id:
    description: "Source Genie Space ID to export"
    default: ""

  # Output path for exports
  export_output:
    description: "Output path for exported Genie Space config"
    default: "/Workspace/genie_spaces/exported_space.json"

  # Production workspace host (for prod target)
  prod_workspace_host:
    description: "Production workspace URL"
    default: ""

  # Production warehouse ID (for prod target)
  prod_warehouse_id:
    description: "Production SQL Warehouse ID"
    default: ""

artifacts:
  genie_migration_wheel:
    type: whl
    path: .

resources:
  jobs:
    export_genie_space:
      name: "genie-export-${bundle.target}"
      description: "Export a Genie Space configuration to JSON"
      tasks:
        - task_key: export
          python_wheel_task:
            package_name: genie_migration
            entry_point: genie-export
            parameters:
              - "--space-id"
              - "${var.source_space_id}"
              - "--output"
              - "${var.export_output}"
              - "--verbose"
          libraries:
            - whl: ./dist/*.whl
          environment_key: default
      environments:
        - environment_key: default
          spec:
            dependencies:
              - databricks-sdk>=0.20.0
      timeout_seconds: 600
      max_concurrent_runs: 1

    deploy_genie_space:
      name: "genie-deploy-${bundle.target}"
      description: "Deploy a Genie Space from JSON configuration"
      tasks:
        - task_key: deploy
          python_wheel_task:
            package_name: genie_migration
            entry_point: genie-deploy
            parameters:
              - "--config"
              - "${var.genie_config}"
              - "--warehouse-id"
              - "${var.warehouse_id}"
              - "--parent-path"
              - "${var.genie_parent_path}"
              - "--space-id"
              - "${var.space_id}"
              - "--verbose"
          libraries:
            - whl: ./dist/*.whl
          environment_key: default
      environments:
        - environment_key: default
          spec:
            dependencies:
              - databricks-sdk>=0.20.0
      timeout_seconds: 600
      max_concurrent_runs: 1

targets:
  # Development target - configure via DATABRICKS_HOST env var or update host below
  dev:
    mode: development
    default: true
    # Uncomment and set your dev workspace URL:
    # workspace:
    #   host: https://adb-<workspace-id>.<region>.azuredatabricks.net

  # Production target - set via variables or CI/CD
  prod:
    workspace:
      host: ${var.prod_workspace_host}
    variables:
      warehouse_id: ${var.prod_warehouse_id}
